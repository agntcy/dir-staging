# Ref: https://github.com/agntcy/dir/blob/main/install/charts/dir/values.yaml

apiserver:
  log_level: DEBUG

  image:
    repository: ghcr.io/agntcy/dir-apiserver
    tag: v0.5.2
    pullPolicy: IfNotPresent
    pullSecrets: []
  
  # Resource limits for local Kind deployment
  # For production, increase based on expected load (e.g., 500m CPU, 1Gi RAM requests)
  resources:
    requests:
      cpu: 250m          # Modest for local testing
      memory: 512Mi
    limits:
      cpu: 1000m         # Allow bursts
      memory: 2Gi
  
  # ============================================================================
  # OPTIONAL PRODUCTION FEATURES (Not configured in this example)
  # ============================================================================
  # This example uses simple configuration for local Kind/testing.
  # For production deployment, consider enabling:
  #
  # • Persistent Storage (PVCs) - Data persists across restarts
  # • ExternalSecrets - Secure credential management with Vault
  # • Ingress & TLS - External access with certificates
  # • Higher resource limits - Based on expected production load
  #
  # See documentation: https://github.com/agntcy/dir/tree/main/docs/deployment
  # ============================================================================
  
  # Expose the DIR API via NodePort for external access
  service:
    type: NodePort

  # Expose the P2P API via NodePort for external access
  routingService:
    type: NodePort
    nodePort: 30555
    # Preserve source IPs for P2P (recommended)
    externalTrafficPolicy: Local

  # SPIRE configuration
  spire:
    enabled: true
    trustDomain: example.org

  # API server configuration
  config:
    listen_address: "0.0.0.0:8888"

    # Authentication settings (handles identity verification)
    # Supports both X.509 (X.509-SVID) and JWT (JWT-SVID) authentication
    authn:
      # Enable authentication
      enabled: true
      # Authentication mode: "x509" or "jwt"
      # - x509: Uses X.509-SVID from mutual TLS peer certificates
      # - jwt: Uses JWT-SVID from Authorization header
      mode: "x509"
      # SPIFFE Workload API socket path (injected by SPIRE agent)
      socket_path: "unix:///run/spire/agent-sockets/api.sock"
      # Expected audiences for JWT validation (only used in JWT mode)
      audiences:
        - "spiffe://example.org/spire/server"

    # Authorization settings (handles access control policies)
    # Requires authentication to be enabled first
    authz:
      # Enable authorization policies
      enabled: true
      # Trust domain for this Directory server
      # Used to distinguish internal (same trust domain) vs external requests
      trust_domain: "example.org"

    # Rate limiting configuration (NEW in v0.5.0+)
    # Protects against abuse and resource exhaustion
    ratelimit:
      enabled: true
      global_rps: 50         # Requests per second (modest for Kind)
      global_burst: 100      # Burst capacity
      per_client_rps: 100    # Per authenticated client
      per_client_burst: 200
    
    # Store settings for the storage backend.
    store:
      # Storage provider to use.
      provider: "oci"

      # OCI-backed store
      oci:
        # Path to a local directory that will be to hold data instead of remote.
        # If this is set to non-empty value, only local store will be used.
        # local_dir: ""

        # Cache directory to use for metadata.
        # cache_dir: ""

        # Registry address to connect to
        registry_address: "dir-dir-dev-argoapp-zot.dir-dev-dir.svc.cluster.local:5000"
        
        # All data will be stored under this repo.
        # Objects are pushed as tags, manifests, and blobs.
        # repository_name: ""

        # Auth credentials to use.
        auth_config:
          insecure: "true"
          username: "admin"
          password: "admin"

    # Routing settings for the peer-to-peer network.
    routing:
      # Address to use for routing
      listen_address: "/ip4/0.0.0.0/tcp/5555"

      # Path to private key file for peer ID.
      # TODO: generate and mount via secret
      # key_path: /etc/routing/node.privkey

      # Path to the routing datastore
      datastore_dir: /etc/routing/datastore

      # Address of the Directory API server for sync operations
      directory_api_address: dir-dir-dev-argoapp-apiserver.dir-dev-dir.svc.cluster.local:8888

      # Nodes to use for bootstrapping of the DHT.
      # We read initial routing tables here and get introduced
      # to the network.
      # bootstrap_peers:
      #   - /ip4/1.1.1.1/tcp/1
      #   - /ip4/1.1.1.1/tcp/2

      # GossipSub configuration for efficient label announcements
      # When enabled, labels are propagated via GossipSub mesh to ALL subscribed peers
      # When disabled, falls back to DHT+Pull mechanism (higher bandwidth, limited reach)
      # Default: true (recommended for production)
      gossipsub:
        enabled: true

    # Sync configuration
    sync:
      # How frequently the scheduler checks for pending syncs
      scheduler_interval: "30s"
      
      # Maximum number of sync workers running concurrently
      worker_count: 1
      
      # Timeout for individual sync operations
      worker_timeout: "10m"
      
      # Registry monitor configuration
      registry_monitor:
        check_interval: "30s"
      
      # Authentication configuration for sync operations
      auth_config:
        username: "user"
        password: "user"

    # Publication configuration
    publication:
      # How frequently the scheduler checks for pending publications
      scheduler_interval: "1h"
      
      # Maximum number of publication workers running concurrently
      worker_count: 1
      
      # Timeout for individual publication operations
      worker_timeout: "30m"

  # Database configuration (NEW in v0.5.2)
  # This example uses default /tmp/dir.db (ephemeral)
  # For production persistence, uncomment and enable PVC below:
  #
  # database:
  #   type: "sqlite"
  #   sqlite:
  #     dbPath: "/var/lib/dir/database/dir.db"  # Path on PVC
  #   pvc:
  #     enabled: true
  #     create: true
  #     storageClassName: "your-storage-class"
  #     size: 1Gi  # Database size (search index, sync state, publication queue)
  #     accessMode: ReadWriteOnce
  #
  # Benefits: Database persists across restarts, faster recovery, enables readOnlyRootFilesystem

  # Pod Security Standards (NEW in v0.5.2 example)
  # Enhanced security for production-grade deployments
  podSecurityContext:
    fsGroup: 65532            # Allows non-root user to write to volumes
    runAsNonRoot: true        # Enforce non-root execution
    runAsUser: 65532          # Explicit user ID (matches Dockerfile)
    seccompProfile:           # Syscall filtering
      type: RuntimeDefault

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false  # Prevent privilege escalation
    runAsNonRoot: true               # Enforce non-root at container level
    runAsUser: 65532                 # Explicit UID
    capabilities:
      drop:
        - ALL                        # Drop all capabilities (least privilege)
    # Note: readOnlyRootFilesystem not enabled with emptyDir storage
    # For production with PVCs, enable this for maximum security

  # Extra volume mounts for the apiserver container
  extraVolumeMounts: 
  - name: zot-config-storage
    mountPath: /etc/zot
  - name: dir-routing-storage
    mountPath: /etc/routing

  # Extra volumes
  extraVolumes: 
  # Zot config storage volume for config hot-reloading
  - name: zot-config-storage
    hostPath:
      path: /opt/zot-config
      type: DirectoryOrCreate
  # Routing storage volume for peer-to-peer data
  - name: dir-routing-storage
    emptyDir: {}

  # Zot registry configuration (subchart)
  zot:
    # Resource limits for Zot registry
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    
    extraVolumeMounts: []
    extraVolumes: []
    
    # ZOT secrets
    mountSecret: true
    authHeader: "admin:admin"
    secretFiles:
      # Example htpasswd with 'admin:admin' & 'user:user' user:pass pairs
      htpasswd: |-
        admin:$2y$05$vmiurPmJvHylk78HHFWuruFFVePlit9rZWGA/FbZfTEmNRneGJtha
        user:$2y$05$L86zqQDfH5y445dcMlwu6uHv.oXFgT6AiJCwpv3ehr7idc0rI3S2G
  
    # Zot config
    mountConfig: true
    configFiles:
      config.json: |-
        {
          "distSpecVersion": "1.1.1",
          "storage": {
            "rootDirectory": "/var/lib/registry"
          },
          "http": {
            "address": "0.0.0.0",
            "port": "5000",
            "auth": {
              "htpasswd": {
                "path": "/secret/htpasswd"
              }
            },
            "accessControl": {
              "adminPolicy": {
                  "users": ["admin"],
                  "actions": ["read", "create", "update", "delete"]
              },
              "repositories": {
                "**": {
                  "anonymousPolicy": [],
                  "defaultPolicy": ["read"]
                }
              }
            }
          },
          "log": {
            "level": "info"
          },
          "extensions": {
            "search": {
              "enable": true
            },
            "trust": {
              "enable": true,
              "cosign": true,
              "notation": false
            }
          }
        }
