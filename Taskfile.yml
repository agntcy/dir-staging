# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

tasks:
  default:
    cmds:
      - task -l

  gen:
    desc: Generate application manifests
    cmds:
      - task: gen:dir

  gen:dir:
    desc: Generate Directory application manifests
    vars:
      FEDERATION_SOURCE: "{{ .ROOT_DIR }}/onboarding/federation/*.yaml"
      DEST_VALUES: "/tmp/dir_gen_values.yaml"
      DEST_VALUES_DEV: "{{ .ROOT_DIR }}/applications/dir/dev/gen.values.yaml"
      DEST_VALUES_PROD: "{{ .ROOT_DIR }}/applications/dir/prod/gen.values.yaml"
    cmds:
      # Add initial autogen comment to the destination file
      - echo "# This file is autogenerated by 'task gen:dir'." > {{ .DEST_VALUES }}
      - echo "# Do not edit directly." >> {{ .DEST_VALUES }}

      # Merge all federation configs into the destination file.
      # Only use bash and taskfile built-ins for compatibility.
      - |
        # Generate initial federation structure
        cat <<EOF >> {{ .DEST_VALUES }}
        apiserver:
          spire:
            federation:
        EOF

        # Generate federation entries
        hasFederation=false
        for file in {{ .FEDERATION_SOURCE }}; do
          if [ -f "$file" ]; then
            echo "    -" >> {{ .DEST_VALUES }}
            cat "$file" | sed 's/^/      /' >> {{ .DEST_VALUES }}
            hasFederation=true
          fi
        done

        # Create dev and prod values files only if federation entries were found
        if [ "$hasFederation" = true ]; then
          cp {{ .DEST_VALUES }} {{ .DEST_VALUES_DEV }}
          cp {{ .DEST_VALUES }} {{ .DEST_VALUES_PROD }}
        else
          rm -f {{ .DEST_VALUES_DEV }} {{ .DEST_VALUES_PROD }}
        fi
      
      # Cleanup
      - rm -rf {{ .DEST_VALUES }}
